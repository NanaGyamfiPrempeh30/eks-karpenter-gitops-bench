# =============================================================================
# CI Pipeline - GitHub Runners (Baseline for Tenki Cloud comparison)
# =============================================================================

name: CI - Build & Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  GO_VERSION: '1.22'

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./app
    
    steps:
      - name: Record Start Time
        id: start
        run: echo "time=$(date +%s%3N)" >> $GITHUB_OUTPUT
        working-directory: .

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: '**/go.mod'

      - name: Download Dependencies
        run: go mod download

      - name: Build
        id: build
        run: |
          start=$(date +%s%3N)
          CGO_ENABLED=0 go build -ldflags="-s -w" -o ./server .
          end=$(date +%s%3N)
          echo "duration=$((end - start))ms" >> $GITHUB_OUTPUT
          echo " Build completed in $((end - start))ms"

      - name: Test
        id: test
        run: |
          start=$(date +%s%3N)
          go test -v -race -coverprofile=coverage.out ./...
          end=$(date +%s%3N)
          echo "duration=$((end - start))ms" >> $GITHUB_OUTPUT
          echo " Tests completed in $((end - start))ms"

      - name: Benchmark
        run: go test -bench=. -benchmem ./...

      - name: Summary
        working-directory: .
        run: |
          end=$(date +%s%3N)
          start=${{ steps.start.outputs.time }}
          total=$((end - start))
          
          echo "## GitHub Runners - Baseline Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ steps.build.outputs.duration }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ steps.test.outputs.duration }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total Job** | **${total}ms** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo " Runner: \`ubuntu-latest\` (GitHub-hosted)" >> $GITHUB_STEP_SUMMARY