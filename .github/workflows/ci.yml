# =============================================================================
# CI Pipeline - GitHub Runners (Baseline for Tenki Cloud comparison)
# =============================================================================

name: CI - Build & Test

on:
  push:
    branches: [main]
    paths: ['app/**', '.github/workflows/ci.yml']
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  GO_VERSION: '1.22'

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“Š Record Start Time
        id: start
        run: echo "time=$(date +%s%3N)" >> $GITHUB_OUTPUT

      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: app/go.mod

      - name: ðŸ“¦ Download Dependencies
        working-directory: ./app
        run: go mod download

      - name: ðŸ”¨ Build
        id: build
        working-directory: ./app
        run: |
          start=$(date +%s%3N)
          CGO_ENABLED=0 go build -ldflags="-s -w" -o ./server .
          end=$(date +%s%3N)
          echo "duration=$((end - start))ms" >> $GITHUB_OUTPUT
          echo "âœ… Build: $((end - start))ms"

      - name: ðŸ§ª Test
        id: test
        working-directory: ./app
        run: |
          start=$(date +%s%3N)
          go test -v -race -coverprofile=coverage.out ./...
          end=$(date +%s%3N)
          echo "duration=$((end - start))ms" >> $GITHUB_OUTPUT
          echo "âœ… Tests: $((end - start))ms"

      - name: ðŸ“ˆ Benchmark
        working-directory: ./app
        run: go test -bench=. -benchmem ./...

      - name: ðŸ“Š Summary
        run: |
          end=$(date +%s%3N)
          start=${{ steps.start.outputs.time }}
          total=$((end - start))
          
          echo "## ðŸ“Š Pipeline Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ steps.build.outputs.duration }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ steps.test.outputs.duration }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **${total}ms** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Runner: \`ubuntu-latest\` (GitHub-hosted)" >> $GITHUB_STEP_SUMMARY
